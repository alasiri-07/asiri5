<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام بلاغ الحوادث المرورية</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }


        :root {
            --h1-after-background: #3498db;
            --accent-color: #3498db;
            --border-color: #d1d8df;
            --input-bg-color: #fcfdfe;
            --modal-bg: rgba(0, 0, 0, 0.6);
            --modal-content-bg: #fefefe;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --success-color: #28a745;
        }
        
        body {
            font-family: 'Cairo', sans-serif;
            margin: 0;
            padding: 25px 20px;
            background-color: #f2f5f7;
            color: #3f4a56;
            direction: rtl;
            text-align: center;
            min-height: 10vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            background-color: #ffffff;
            padding: 35px 40px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            max-width: 900px;
            margin: 25px auto;
            border: 1px solid #e7eaf0;
            width: 100%;
            overflow: hidden;
        }
        
        h1, h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-weight: 700;
            font-size: 2.4em;
            position: relative;
            line-height: 1.3;
        }
        
        h1::after {
            content: '';
            display: block;
            width: 90px;
            height: 5px;
            background-color: var(--h1-after-background);
            margin: 18px auto 0;
            border-radius: 3px;
            transition: background-color 0.4s ease-in-out;
        }


        h2 {
            color: #2c3e50;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 12px;
            margin-top: 45px;
            font-size: 1.7em;
            text-align: right;
            position: relative;
            padding-right: 40px;
        }


        h2 .icon {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            color: var(--accent-color);
            font-size: 1.2em;
        }
        
        .form-group {
            margin-bottom: 22px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: flex-end;
            padding: 5px 0;
        }
        
        .form-group label {
            font-weight: 600;
            margin-left: 15px;
            color: #5d6d7e;
            font-size: 1.08em;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }


        .form-group label .icon {
            color: #8c9bb0;
            font-size: 0.9em;
        }
        
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group textarea,
        .form-group select,
        .form-group input[list],
        .form-group input[type="tel"] {
            flex: 1;
            padding: 13px 18px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 1.05em;
            box-sizing: border-box;
            background-color: var(--input-bg-color);
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
            min-width: 200px;
        }
        
        .form-group input[type="text"]:focus,
        .form-group input[type="number"]:focus,
        .form-group input[type="date"]:focus,
        .form-group textarea:focus,
        .form-group select:focus,
        .form-group input[list]:focus,
        .form-group input[type="tel"]:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            background-color: #ffffff;
        }
        
        textarea#accident-reason-display {
            min-height: 110px;
            resize: vertical;
        }
        
        .car-details {
            margin-top: 25px;
            padding: 20px 30px;
            border-right: 5px solid var(--accent-color);
            background-color: #fdfdfd;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.06);
            transition: border-color 0.4s ease-in-out;
        }


        .car-details div {
            margin-bottom: 15px;
        }


        .car-details h4 {
            color: #34495e;
            font-size: 1.3em;
            margin-top: 0;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #e0e0e0;
            text-align: right;
            padding-right: 5px;
        }
        
        .car-plate-numbers input {
            width: 100%;
            max-width: 130px;
            text-align: center;
            margin: 0 6px;
            padding: 12px 10px;
            font-size: 1.1em;
        }
        
        .car-plate-numbers span {
            font-weight: bold;
            color: #555;
            font-size: 1.1em;
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 18px;
            padding: 8px 0;
            font-size: 1.05em;
            justify-content: flex-end;
            cursor: pointer;
        }
        
        .checkbox-container input[type="checkbox"],
        .checkbox-container input[type="radio"] {
            margin-right: 18px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: var(--accent-color);
            border-radius: 6px;
            border: 2px solid var(--accent-color);
            transition: all 0.2s ease-in-out;
            flex-shrink: 0;
        }
        
        .checkbox-container label {
            font-weight: normal;
            font-size: 1.05em;
            color: #4c5b6b;
            cursor: pointer;
        }


        .checkbox-container input[type="checkbox"]:checked,
        .checkbox-container input[type="radio"]:checked {
            transform: scale(1.05);
        }
        
        .footer-note {
            text-align: center;
            margin-top: 50px;
            font-size: 1.15em;
            color: #777;
            font-weight: 600;
            padding-top: 15px;
            border-top: 1px dashed #e0e0e0;
        }
        
        .copy-button-container {
            text-align: center;
            margin-top: 40px;
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            padding-top: 15px;
            border-top: 1px dashed #e0e0e0;
        }
        
        .copy-button, .back-button, .settings-button {
            color: white;
            padding: 15px 35px;
            border: none;
            border-radius: 10px;
            font-size: 1.35em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.12);
            display: inline-flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
        }
        
        .copy-button {
            background-color: var(--success-color);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
        
        .copy-button:hover {
            background-color: #218838;
            transform: translateY(-3px);
        }
        
        .back-button {
            background-color: #6c757d;
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
        }
        
        .back-button:hover {
            background-color: #5a6268;
            transform: translateY(-3px);
        }
        
        .settings-button {
            background-color: #007bff;
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
        }
        
        .settings-button:hover {
            background-color: #0056b3;
            transform: translateY(-3px);
        }
        
        .edit-button {
            background-color: #ffc107;
            color: #212529;
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .edit-button:hover {
            background-color: #e0a800;
            transform: translateY(-2px);
        }
        
        .edit-button:active {
            transform: translateY(0);
        }
        
        .copy-button:active, .back-button:active, .settings-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }


        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: var(--modal-bg);
            padding: 20px;
            box-sizing: border-box;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: var(--modal-content-bg);
            margin: auto;
            padding: 35px;
            border: 1px solid #ddd;
            border-radius: 15px;
            width: 95%;
            max-width: 650px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.35);
            position: relative;
            animation: fadeIn 0.4s ease-out;
        }
        
        @keyframes fadeIn {
            from {opacity: 0; transform: translateY(-30px) scale(0.95);}
            to {opacity: 1; transform: translateY(0) scale(1);}
        }
        
        .close-button {
            color: #999;
            float: left;
            font-size: 32px;
            font-weight: bold;
            margin-left: -15px;
            line-height: 1;
            transition: color 0.2s ease;
        }
        
        .close-button:hover,
        .close-button:focus {
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }
        
        .modal-content h3 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 1.6em;
            font-weight: 700;
        }
        
        #report-output {
            width: 100%;
            height: 350px;
            padding: 18px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background-color: #f9fbfd;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 1.05em;
            line-height: 1.7;
            white-space: pre-wrap;
            overflow-y: auto;
            resize: vertical;
            color: #333;
        }
        
        .modal-copy-button-container {
            text-align: center;
            margin-top: 30px;
        }
        
        .modal-copy-button {
            background-color: #3498db;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.15em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.2);
        }
        
        .modal-copy-button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }


        .modal-copy-button:active {
            transform: translateY(0);
        }
        
        .success-message {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
            margin-top: 25px;
            display: none;
            font-size: 1.1em;
            font-weight: 600;
        }


        /* Initial Page Styles */
        #initial-page {
            text-align: center;
            padding: 60px;
            background-color: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            max-width: 650px;
            width: 100%;
            margin: 0 auto;
        }
        
        #initial-page h1 {
            color: #2c3e50;
            margin-bottom: 45px;
        }
        
        #initial-page h1::after {
            display: none;
        }
        
        .accident-type-option {
            margin-bottom: 25px;
        }
        
        .accident-type-option button {
            background-color: #3498db;
            color: white;
            padding: 18px 35px;
            border: none;
            border-radius: 10px;
            font-size: 1.3em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            width: 90%;
            max-width: 350px;
            display: block;
            margin: 0 auto;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .accident-type-option button.fatal {
            background-color: var(--danger-color);
        }
        
        .accident-type-option button.injuries {
            background-color: var(--warning-color);
        }
        
        .accident-type-option button.normal {
            background-color: #3498db;
        }
        
        .accident-type-option button:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        #report-form-container, #settings-page {
            display: none; 
        }
        
        .location-input-group {
            display: none;
            margin-top: 20px;
            align-items: center;
            justify-content: center;
        }
        
        .location-input-group label {
            font-weight: 600;
            margin-left: 10px;
            min-width: 160px;
            color: #555;
            font-size: 1.05em;
        }
        
        .location-input-group input {
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1em;
            flex: 1;
            max-width: 300px;
        }


        /* Kilometer Mark Specific Styling */
        .kilometer-mark-group {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            position: relative;
            justify-content: flex-end;
        }


        .kilometer-mark-group label {
            min-width: 160px;
            margin-left: 15px;
        }


        .input-with-label-bg {
            position: relative;
            flex: 1;
            min-width: 100px;
        }


        .input-with-label-bg input {
            width: 100%;
            text-align: center;
            padding-right: 40px;
            padding-left: 40px;
        }


        .input-with-label-bg::before {
            content: attr(data-text);
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #b0b0b0;
            font-size: 0.9em;
            pointer-events: none;
            z-index: 1;
        }
        
        .input-with-label-bg.km::before {
            left: 12px;
            right: auto;
        }


        /* Settings Page Specific Styles */
        #settings-page h2 {
            text-align: right;
            margin-top: 35px;
            margin-bottom: 25px;
            font-size: 1.55em;
            color: #34495e;
            border-bottom: 1px solid #e7eaf0;
            padding-bottom: 12px;
        }
        
        #settings-page .form-group {
            align-items: flex-start;
            flex-direction: column;
            gap: 10px;
        }
        
        #settings-page .form-group label {
            min-width: unset;
            margin-left: 0;
            margin-bottom: 5px;
            font-size: 1.0em;
        }
        
        #settings-page .form-group input[type="text"],
        #settings-page .form-group select {
            width: 100%;
            max-width: 100%;
        }
        
        #settings-page .copy-button-container {
            margin-top: 20px;
            margin-bottom: 30px;
            justify-content: flex-end;
            border-top: none;
            padding-top: 0;
        }
        
        #settings-page .copy-button-container button {
            padding: 12px 25px;
            font-size: 1.1em;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        #settings-page select[size] {
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px;
            background-color: var(--input-bg-color);
            font-size: 1em;
            box-sizing: border-box;
            min-height: 150px;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }


        #settings-page select[size]:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .contractor-select-group {
            display: flex;
            align-items: center;
            width: 100%;
            gap: 10px;
        }
        
        .contractor-select-group select {
            flex: 1;
        }
        
        .injury-edit-group {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        
        .injury-edit-group input {
            flex: 1;
        }
        
        .excel-upload-container {
            border: 2px dashed #3498db;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            background-color: #f8fbff;
            margin-bottom: 25px;
        }
        
        .excel-upload-container p {
            margin-bottom: 15px;
            font-size: 1.1em;
            color: #555;
        }
        
        .excel-upload-container .upload-btn {
            background-color: #3498db;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .excel-upload-container .upload-btn:hover {
            background-color: #2980b9;
        }
        
        .excel-upload-container .file-name {
            margin-top: 15px;
            font-size: 0.95em;
            color: #666;
        }
        
        .excel-upload-container .instructions {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f7ff;
            border-radius: 8px;
            font-size: 0.95em;
            color: #444;
            text-align: right;
        }
        
        .excel-upload-container .instructions h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .excel-upload-container .instructions ul {
            text-align: right;
            padding-right: 20px;
        }
        
        .excel-upload-container .instructions li {
            margin-bottom: 8px;
        }


        /* Accident Instructions */
        .accident-instructions {
            background-color: #fff8e1;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border-right: 4px solid #ffc107;
            font-size: 0.95em;
        }
        
        .accident-instructions h4 {
            color: #d32f2f;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .accident-instructions ul {
            padding-right: 20px;
        }
        
        .accident-instructions li {
            margin-bottom: 8px;
            position: relative;
            padding-right: 15px;
        }
        
        .accident-instructions li::before {
            content: "•";
            position: absolute;
            right: 0;
            color: #d32f2f;
            font-size: 1.2em;
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 25px 20px;
                margin: 15px auto;
            }


            h1 {
                font-size: 2em;
            }


            h2 {
                font-size: 1.5em;
                padding-right: 30px;
            }


            .form-group {
                flex-direction: column;
                align-items: flex-end;
                gap: 10px;
            }


            .form-group label {
                margin-left: 0;
                width: 100%;
                text-align: right;
            }


            .form-group input,
            .form-group textarea,
            .form-group select {
                width: 100%;
                max-width: 100%;
                min-width: unset;
            }


            .kilometer-mark-group {
                flex-direction: row;
                justify-content: center;
                width: 100%;
            }


            .kilometer-mark-group label {
                width: 100%;
                text-align: right;
            }


            .kilometer-mark-group .input-with-label-bg {
                width: calc(50% - 15px);
                min-width: unset;
            }


            .car-plate-numbers input {
                max-width: 100px;
            }


            .copy-button-container button {
                width: 100%;
                max-width: 300px;
                margin: 0 auto;
            }


            .modal-content {
                padding: 25px;
            }


            #report-output {
                font-size: 0.95em;
                height: 250px;
            }
        }


        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 20px 15px;
            }
            h1 {
                font-size: 1.8em;
            }
            h2 {
                font-size: 1.3em;
            }
            .form-group input,
            .form-group textarea,
            .form-group select {
                padding: 10px 12px;
                font-size: 0.95em;
            }
            .copy-button, .back-button, .settings-button {
                padding: 12px 20px;
                font-size: 1.1em;
            }
            .car-plate-numbers input {
                max-width: 80px;
                font-size: 1em;
            }
            .input-with-label-bg input {
                padding-right: 30px;
                padding-left: 30px;
            }
            .input-with-label-bg::before,
            .input-with-label-bg.km::before {
                font-size: 0.8em;
                left: 8px;
                right: 8px;
            }
            #initial-page button {
                padding: 15px 25px;
                font-size: 1.1em;
            }
        }
    </style>
</head>
<body>
    <div id="initial-page">
        <h1>الرجاء اختيار نوع الحادث</h1>
        <div class="accident-type-option">
            <button class="fatal" onclick="app.startReport('fatal')"><i class="fa-solid fa-triangle-exclamation"></i> حادث وفيات 🔴</button>
            <div class="accident-instructions">
                <h4><i class="fa-solid fa-info-circle"></i> تعليمات الحوادث التي تشملها:</h4>
                <ul>
                    <li>حوادث الوفيات</li>
                    <li>حادث باص او نقل معلمات</li>
                    <li>حوادث الحيوانات السائبة</li>
                    <li>حوادث ناقلة مواد بترولية</li>
                    <li>حوادث دهس</li>
                    <li>حادثة معدة تابعة للمشروع</li>
                    <li>حوادث تحويلة على الطرق</li>
                </ul>
            </div>
        </div>
        <div class="accident-type-option">
            <button class="injuries" onclick="app.startReport('injuries')"><i class="fa-solid fa-hospital-user"></i> حادث إصابات 🟡</button>
        </div>
        <div class="accident-type-option">
            <button class="normal" onclick="app.startReport('normal')"><i class="fa-solid fa-car-burst"></i> حادث عادي 🔵</button>
        </div>
        <div class="accident-type-option">
            <button class="settings-button" onclick="app.showSettingsPage()"><i class="fa-solid fa-gear"></i> الإعدادات</button>
        </div>
    </div>


    <div id="report-form-container" class="container">
        <h1 id="report-title">بلاغ عاجل بوقوع حادث مروري</h1>


        <div class="form-group">
            <label for="report-id"><i class="fa-solid fa-receipt icon"></i> رقم البلاغ في رقابة +:</label>
            <input type="text" id="report-id" value="508090">
        </div>


        <h2><span class="icon"><i class="fa-solid fa-location-dot"></i></span> معلومات الموقع
            <span id="location-field" class="location-input-group">
                : <input type="text" id="location-text" placeholder="أدخل الموقع هنا">
            </span>
        </h2>
        <div class="form-group">
            <label for="road-name-select"><i class="fa-solid fa-road icon"></i> اسم الطريق :</label>
            <select id="road-name-select"></select>
        </div>
        <div class="form-group">
            <label for="road-number-display"><i class="fa-solid fa-hashtag icon"></i> رقم الطريق :</label>
            <input type="text" id="road-number-display" readonly>
        </div>
        <div class="form-group">
            <label for="road-type"><i class="fa-solid fa-road icon"></i> نوع الطريق :</label>
            <select id="road-type">
                <option value="مفرد">مفرد</option>
                <option value="مزدوج">مزدوج</option>
                <option value="سريع" selected>سريع</option>
            </select>
        </div>
        <div class="form-group kilometer-mark-group">
            <label for="kilometer-mark-m"><i class="fa-solid fa-map-marker-alt icon"></i> العلامة الكيلومترية:</label>
            <span>(</span>
            <div class="input-with-label-bg" data-text="متر">
                <input type="number" id="kilometer-mark-m" placeholder="" value="350" max="999">
            </div>
            <span>+</span>
            <div class="input-with-label-bg km" data-text="كيلو">
                <input type="number" id="kilometer-mark-km" placeholder="" value="360">
            </div>
            <span>)</span>
        </div>
        <div class="form-group">
            <label for="direction"><i class="fa-solid fa-signs-post icon"></i> الاتجاه :</label>
            <select id="direction">
                <option value="رئيسي" selected>رئيسي</option>
                <option value="عكسي">عكسي</option>
            </select>
        </div>
        <div class="form-group">
            <label for="location-description"><i class="fa-solid fa-map-marked-alt icon"></i> وصف الموقع :</label>
            <textarea id="location-description" rows="3">أبيار الماشي</textarea>
        </div>
        <div class="form-group">
            <label for="contract-number"><i class="fa-solid fa-file-contract icon"></i> رقم العقد :</label>
            <input type="text" id="contract-number" value="404">
        </div>
        <div class="form-group">
            <label for="contractor-name"><i class="fa-solid fa-user-tie icon"></i> اسم المقاول :</label>
            <div class="contractor-select-group">
                <select id="contractor-name"></select>
                <button class="edit-button" onclick="app.showContractorModal()">
                    <i class="fa-solid fa-pen"></i> تعديل
                </button>
            </div>
        </div>


        <h2><span class="icon"><i class="fa-solid fa-triangle-exclamation"></i></span> نتيجة الحادث</h2>
        <div class="form-group">
            <label for="injuries-count-display"><i class="fa-solid fa-hospital-user icon"></i> عدد الإصابات :</label>
            <div class="injury-edit-group">
                <input type="text" id="injuries-count-display" value="لايوجد" readonly>
                <button class="edit-button" onclick="app.showInjuryModal('injuries')">
                    <i class="fa-solid fa-pen"></i> تعديل
                </button>
            </div>
        </div>
        <div class="form-group">
            <label for="fatalities-count-display"><i class="fa-solid fa-person-falling-burst icon"></i> عدد الوفيات :</label>
            <div class="injury-edit-group">
                <input type="text" id="fatalities-count-display" value="لايوجد" readonly>
                <button class="edit-button" onclick="app.showInjuryModal('fatalities')">
                    <i class="fa-solid fa-pen"></i> تعديل
                </button>
            </div>
        </div>
        <div class="form-group">
            <label for="damages-input"><i class="fa-solid fa-wrench icon"></i> التلفيات:</label>
            <input type="text" id="damages-input" list="damages-options" value="لايوجد" placeholder="أدخل التلفيات أو اختر">
            <datalist id="damages-options"></datalist>
        </div>


        <div class="form-group">
            <label for="car-count"><i class="fa-solid fa-car icon"></i> عدد السيارات :</label>
            <input type="tel" id="car-count" min="0" value="2" pattern="[0-9]*" inputmode="numeric">
        </div>
        <div id="car-details-container">
            <div class="car-details">
                <h4>السيارة رقم 1</h4>
                <div class="form-group">
                    <label for="car-type-1"><i class="fa-solid fa-car-side icon"></i> نوعها :</label>
                    <input type="text" id="car-type-1" list="car-models-options" placeholder="ادخل نوع المركبة" value="تويوتا كامري">
                </div>
                <div class="form-group car-plate-numbers">
                    <label><i class="fa-solid fa-id-card icon"></i> رقم اللوحة :</label>
                    <span>(</span>
                    <input type="text" id="plate-letters-1" placeholder="أحرف" value="ا ح م">
                    <span>/</span>
                    <input type="text" id="plate-numbers-1" pattern="[0-9]*" inputmode="numeric" placeholder="أرقام" value="5008">
                    <span>)</span>
                </div>
            </div>
            <div class="car-details">
                <h4>السيارة رقم 2</h4>
                <div class="form-group">
                    <label for="car-type-2"><i class="fa-solid fa-car-side icon"></i> نوعها :</label>
                    <input type="text" id="car-type-2" list="car-models-options" placeholder="ادخل نوع المركبة" value="تويوتا كورولا">
                </div>
                <div class="form-group car-plate-numbers">
                    <label><i class="fa-solid fa-id-card icon"></i> رقم اللوحة :</label>
                    <span>(</span>
                    <input type="text" id="plate-letters-2" placeholder="أحرف" value="ع ز ز">
                    <span>/</span>
                    <input type="text" id="plate-numbers-2" pattern="[0-9]*" inputmode="numeric" placeholder="أرقام" value="6006">
                    <span>)</span>
                </div>
            </div>
        </div>
        <datalist id="car-models-options"></datalist> 
        <div class="form-group">
            <label for="accident-reason-search"><i class="fa-solid fa-file-lines icon"></i> سبب الحادث (ابحث أو اكتب):</label>
            <input type="text" id="accident-reason-search" list="accident-reason-options" placeholder="ابحث عن سبب أو اكتبه" value="عدم الانتباه أدى إلى انحراف المركبة واصدامها في الحاجز المعدني وانقلابها.">
            <datalist id="accident-reason-options"></datalist>
            <label for="accident-reason-display" style="display: none;">السبب:</label> <textarea id="accident-reason-display" rows="4" class="large-input"></textarea>
        </div>


        <div class="form-group">
            <label for="hour"><i class="fa-regular fa-clock icon"></i> الساعة:</label>
            <input type="text" id="hour" value="">
        </div>
        <div class="form-group">
            <label for="date"><i class="fa-regular fa-calendar-alt icon"></i> التاريخ:</label>
            <input type="date" id="date" value="">
        </div>
        <div class="form-group">
            <label for="day"><i class="fa-solid fa-sun icon"></i> اليوم :</label>
            <input type="text" id="day" readonly>
        </div>


        <h2><span class="icon"><i class="fa-solid fa-circle-info"></i></span> معلومات عامة</h2>
        <div class="form-group">
            <label for="traffic-delay-input"><i class="fa-solid fa-road-barrier icon"></i> زمن تباطؤ حركة المرور:</label>
            <input type="text" id="traffic-delay-input" list="traffic-delay-options" value="لا يوجد تباطؤ" class="large-input" placeholder="أدخل السبب أو اختر من القائمة">
            <datalist id="traffic-delay-options"></datalist>
        </div>
        <div class="form-group">
            <label for="weather-condition"><i class="fa-solid fa-cloud-sun icon"></i> الحالة الجوية :</label>
            <select id="weather-condition">
                <option value="صحو" selected>صحو</option>
                <option value="ممطر">ممطر</option>
                <option value="غائم">غائم</option>
                <option value="عاصفة رملية">عاصفة رملية</option>
            </select>
        </div>
        <div class="form-group">
            <label for="road-condition"><i class="fa-solid fa-road icon"></i> حالة الطريق :</label>
            <input type="text" id="road-condition" value="جيدة">
        </div>
        <div class="form-group">
            <label for="visibility"><i class="fa-solid fa-eye icon"></i> وضوح الرؤية :</label>
            <input type="text" id="visibility" value="واضحة">
        </div>


        <h2><span class="icon"><i class="fa-solid fa-shield-alt"></i></span> الإجراء الذي تم من قبل المقاول</h2>
        <div class="checkbox-container">
            <input type="checkbox" id="action1" checked>
            <label for="action1"><i class="fa-solid fa-check-circle"></i> 1️⃣ تأمين موقع الحادث.</label>
        </div>
        <div class="form-group" style="flex-wrap: nowrap; justify-content: flex-end;">
            <label style="margin-left: 0;"><i class="fa-solid fa-broom icon"></i> 2️⃣ تنظيف موقع الحادث :</label>
            <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-right: 15px;">
                <div class="checkbox-container" style="margin-bottom: 0;">
                    <input type="radio" id="clean-done" name="cleaning-status" value="تنظيف موقع الحادث." checked>
                    <label for="clean-done">تم التنظيف موقع الحادث</label>
                </div>
                <div class="checkbox-container" style="margin-bottom: 0;">
                    <input type="radio" id="clean-in-progress" name="cleaning-status" value="جاري تنظيف موقع الحادث.">
                    <label for="clean-in-progress">جاري تنظيف موقع الحادث</label>
                </div>
            </div>
        </div>
        <div class="checkbox-container">
            <input type="checkbox" id="action3" checked>
            <label for="action3"><i class="fa-solid fa-traffic-cone"></i> 3️⃣ وضع وسائل السلامة.</label>
        </div>


        <div class="copy-button-container">
            <button class="copy-button" onclick="app.showReportModal()">
                <i class="fa-brands fa-whatsapp"></i> نسخ التقرير للواتساب
            </button>
            <button class="back-button" onclick="app.showInitialPage()">
                <i class="fa-solid fa-home"></i> العودة للقائمة الرئيسية
            </button>
        </div>


        <div class="success-message" id="successMessage">
            ✅ تم نسخ التقرير بنجاح!
        </div>


        <p class="footer-note">🚧 المرور والسلامة بالمشروع 🚧</p>
    </div>


    <div id="settings-page" class="container" style="display: none;">
        <h1><i class="fa-solid fa-gear"></i> الإعدادات</h1>


        <h2><span class="icon"><i class="fa-solid fa-user-tie"></i></span> إدارة المقاولين</h2>
        <div class="form-group">
            <label for="new-contractor"><i class="fa-solid fa-plus-circle icon"></i> اسم مقاول جديد:</label>
            <input type="text" id="new-contractor" placeholder="أدخل اسم مقاول جديد">
        </div>
        <div class="copy-button-container">
            <button class="copy-button" onclick="app.addContractor()">➕ إضافة مقاول</button>
        </div>
        <div class="form-group">
            <label><i class="fa-solid fa-list icon"></i> المقاولون الحاليون:</label>
            <select id="current-contractors-list" size="5" style="flex: 1; min-height: 120px;"></select>
        </div>
        <div class="copy-button-container">
            <button class="back-button" onclick="app.removeSelectedContractor()">🗑 حذف المحدد</button>
        </div>


        <h2><span class="icon"><i class="fa-solid fa-road"></i></span> إدارة الطرق</h2>
        <div class="form-group">
            <label for="new-road-name"><i class="fa-solid fa-road icon"></i> اسم الطريق:</label>
            <input type="text" id="new-road-name" placeholder="مثال: طريق الملك فهد">
        </div>
        <div class="form-group">
            <label for="new-road-number"><i class="fa-solid fa-hashtag icon"></i> رقم الطريق:</label>
            <input type="text" id="new-road-number" placeholder="مثال: 5">
        </div>
        <div class="form-group">
            <label for="new-road-type-setting"><i class="fa-solid fa-road icon"></i> نوع الطريق:</label>
            <select id="new-road-type-setting">
                <option value="مفرد">مفرد</option>
                <option value="مزدوج">مزدوج</option>
                <option value="سريع" selected>سريع</option>
            </select>
        </div>
        <div class="copy-button-container">
            <button class="copy-button" onclick="app.addRoad()">➕ إضافة طريق</button>
        </div>
        <div class="form-group">
            <label><i class="fa-solid fa-list icon"></i> الطرق الحالية:</label>
            <select id="current-roads-list" size="5" style="flex: 1; min-height: 120px;"></select>
        </div>
        <div class="copy-button-container">
            <button class="back-button" onclick="app.removeSelectedRoad()">🗑 حذف المحدد</button>
        </div>


        <h2><span class="icon"><i class="fa-solid fa-file-excel"></i></span> رفع ملف إكسل</h2>
        <div class="excel-upload-container">
            <p>ارفع ملف إكسل لتخزين بيانات الطرق والعقود</p>
            <input type="file" id="excel-file" accept=".xlsx, .xls" style="display: none;">
            <button class="upload-btn" onclick="document.getElementById('excel-file').click()">
                <i class="fa-solid fa-file-arrow-up"></i> اختر ملف إكسل
            </button>
            <div id="file-name" class="file-name"></div>
            
            <div class="instructions">
                <h4>تعليمات تنسيق ملف الإكسل:</h4>
                <ul>
                    <li>يجب أن يحتوي الملف على الأعمدة التالية بالترتيب:</li>
                    <li>1. رقم العقد</li>
                    <li>2. رقم الطريق</li>
                    <li>3. اسم الطريق</li>
                    <li>4. نوع الطريق</li>
                    <li>يجب أن تكون البيانات في الورقة الأولى فقط</li>
                </ul>
            </div>
        </div>


        <h2><span class="icon"><i class="fa-solid fa-car"></i></span> إدارة المركبات</h2>
        <div class="form-group">
            <label for="new-car-company"><i class="fa-solid fa-building icon"></i> اسم الشركة:</label>
            <input type="text" id="new-car-company" placeholder="مثال: تويوتا">
        </div>
        <div class="form-group">
            <label for="new-car-model"><i class="fa-solid fa-car-side icon"></i> اسم المركبة:</label>
            <input type="text" id="new-car-model" placeholder="مثال: كامري">
        </div>
        <div class="copy-button-container">
            <button class="copy-button" onclick="app.addCarModel()">➕ إضافة مركبة</button>
        </div>
        <div class="form-group">
            <label><i class="fa-solid fa-list icon"></i> المركبات الحالية:</label>
            <select id="current-car-models-list" size="5" style="flex: 1; min-height: 120px;"></select>
        </div>
        <div class="copy-button-container">
            <button class="back-button" onclick="app.removeSelectedCarModel()">🗑 حذف المحدد</button>
        </div>


        <h2><span class="icon"><i class="fa-solid fa-file-lines"></i></span> إدارة أسباب الحوادث</h2>
        <div class="form-group">
            <label for="new-accident-reason"><i class="fa-solid fa-plus-circle icon"></i> سبب جديد:</label>
            <input type="text" id="new-accident-reason" placeholder="أدخل سبب حادث جديد">
        </div>
        <div class="copy-button-container">
            <button class="copy-button" onclick="app.addAccidentReason()">➕ إضافة سبب</button>
        </div>
        <div class="form-group">
            <label><i class="fa-solid fa-list icon"></i> الأسباب الحالية:</label>
            <select id="current-accident-reasons-list" size="5" style="flex: 1; min-height: 120px;"></select>
        </div>
        <div class="copy-button-container">
            <button class="back-button" onclick="app.removeSelectedAccidentReason()">🗑 حذف المحدد</button>
        </div>


        <h2><span class="icon"><i class="fa-solid fa-wrench"></i></span> إدارة التلفيات</h2>
        <div class="form-group">
            <label for="new-damage"><i class="fa-solid fa-plus-circle icon"></i> تلفيات جديدة:</label>
            <input type="text" id="new-damage" placeholder="أدخل وصف تلفيات جديد">
        </div>
        <div class="copy-button-container">
            <button class="copy-button" onclick="app.addDamage()">➕ إضافة تلفيات</button>
        </div>
        <div class="form-group">
            <label><i class="fa-solid fa-list icon"></i> التلفيات الحالية:</label>
            <select id="current-damages-list" size="5" style="flex: 1; min-height: 120px;"></select>
        </div>
        <div class="copy-button-container">
            <button class="back-button" onclick="app.removeSelectedDamage()">🗑 حذف المحدد</button>
        </div>


        <h2><span class="icon"><i class="fa-solid fa-traffic-light"></i></span> إدارة تباطؤ حركة المرور</h2>
        <div class="form-group">
            <label for="new-traffic-delay"><i class="fa-solid fa-plus-circle icon"></i> تباطؤ جديد:</label>
            <input type="text" id="new-traffic-delay" placeholder="أدخل وصف تباطؤ جديد">
        </div>
        <div class="copy-button-container">
            <button class="copy-button" onclick="app.addTrafficDelay()">➕ إضافة تباطؤ</button>
        </div>
        <div class="form-group">
            <label><i class="fa-solid fa-list icon"></i> التباطؤ الحالي:</label>
            <select id="current-traffic-delays-list" size="5" style="flex: 1; min-height: 120px;"></select>
        </div>
        <div class="copy-button-container">
            <button class="back-button" onclick="app.removeSelectedTrafficDelay()">🗑 حذف المحدد</button>
        </div>


        <div class="copy-button-container" style="margin-top: 50px;">
            <button class="back-button" onclick="app.showInitialPage()">العودة للقائمة الرئيسية</button>
        </div>
    </div>


    <div id="contractorModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="app.closeContractorModal()">&times;</span>
            <h3><i class="fa-solid fa-user-tie"></i> إدارة المقاولين</h3>
            
            <div class="form-group">
                <label for="new-contractor-modal"><i class="fa-solid fa-plus-circle icon"></i> اسم مقاول جديد:</label>
                <input type="text" id="new-contractor-modal" placeholder="أدخل اسم مقاول جديد">
            </div>
            <div class="copy-button-container">
                <button class="copy-button" onclick="app.addContractorFromModal()">➕ إضافة مقاول</button>
            </div>
            
            <div class="form-group">
                <label><i class="fa-solid fa-list icon"></i> المقاولون الحاليون:</label>
                <select id="current-contractors-modal" size="5" style="flex: 1; min-height: 150px;"></select>
            </div>
            
            <div class="copy-button-container">
                <button class="back-button" onclick="app.removeSelectedContractorFromModal()">🗑 حذف المحدد</button>
            </div>
            
            <div class="copy-button-container">
                <button class="copy-button" onclick="app.selectContractorFromModal()">✔️ اختيار المقاول</button>
            </div>
        </div>
    </div>


    <div id="injuryModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="app.closeInjuryModal()">&times;</span>
            <h3 id="injury-modal-title"><i class="fa-solid fa-hospital-user"></i> تعديل الإصابات</h3>
            
            <div class="form-group">
                <label for="injury-count-input"><i class="fa-solid fa-notes-medical icon"></i> العدد (رقم أو "لايوجد"):</label>
                <input type="text" id="injury-count-input" value="لايوجد">
            </div>
            
            <div class="form-group">
                <label for="injury-details"><i class="fa-solid fa-file-medical icon"></i> التفاصيل (اختياري):</label>
                <textarea id="injury-details" rows="3" placeholder="أدخل تفاصيل الإصابات (اختياري)"></textarea>
            </div>
            
            <div class="copy-button-container">
                <button class="copy-button" onclick="app.saveInjuryData()">💾 حفظ البيانات</button>
            </div>
        </div>
    </div>


    <div id="reportModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="app.closeReportModal()">&times;</span>
            <h3>التقرير الجاهز للنسخ</h3>
            <textarea id="report-output" readonly></textarea>
            <div class="modal-copy-button-container">
                <button class="modal-copy-button" onclick="app.copyTextFromModal()"><i class="fa-solid fa-copy"></i> نسخ النص</button>
            </div>
        </div>
    </div>


    <script>
        // البيانات الافتراضية
        const DEFAULT_DATA = {
            roads: [
                { name: 'مكة المكرمة / المدينة المنورة', number: '15', type: 'سريع' },
                { name: 'الرياض / القصيم', number: '65', type: 'سريع' }
            ],
            accidentReasons: [
                "عدم الانتباه أدى إلى انحراف المركبة وانقلابها في الطريق.",
                "عدم الانتباه أدى إلى انحراف المركبة وانقلابها خارج الطريق.",
                "عدم الانتباه أدى إلى انحراف خارج الطريق.",
                "عدم الانتباه أدى إلى انحراف المركبة واصدامها في الحاجز المعدني.",
                "عدم الانتباه أدى إلى انحراف المركبة واصدامها في الحاجز المعدني ثم انقلابها خارج الطريق.",
                "عدم الانتباه أدى إلى انحراف المركبة واصدامها في الحاجز المعدني وانقلابها.",
                "عدم الانتباه أدى إلى انحراف المركبة واصدامها في الحاجز الخرساني",
                "عدم الانتباه أدى إلى انحراف المركبة واصدامها في الحاجز الخرساني ثم انقلابها خارج الطريق.",
                "عدم الانتباه أدى إلى انحراف المركبة واصدامها في الحاجز الخرساني وانقلابها.",
                "عدم الانتباه أدى إلى انحراف المركبة واصدامها في السياج السلكي.",
                "عدم الانتباه أدى إلى انحراف المركبة واصدامها في السياج السلكي وانقلابها.",
                "عدم الانتباه أدى إلى انحراف المركبة واصدامها في السياج السلكي ثم انقلابها خارج الطريق.",
                "عدم الانتباه أدى إلى انحراف المركبة واصدامها في السياج السلكي ثم انقلابها في الجزيرة الوسطية.",
                "عدم الانتباه أدى إلى اصطدام المركبة في السياج في الجزيرة الوسطية.",
                "عدم الانتباه أدى إلى اصطدام المركبة رقم 1 في المركبة رقم 2 من الخلف.",
                "عدم الانتباه أدى إلى اصطدام المركبة رقم 1 في المركبة رقم 2 من الجنب.",
                "عدم الانتباه أدى إلى اصطدام المركبة رقم 1 في المركبات رقم 2،3.",
                "عدم الانتباه أدى إلى اصطدام المركبة رقم 1 في المركبات رقم 2،3،4.",
                "عدم الانتباه أدى إلى اصطدام المركبة رقم 1 في المركبة رقم 2 من الخلف ثم انقلابها في الطريق.",
                "عدم الانتباه أدى إلى اصطدام المركبة رقم 1 في المركبة رقم 2 من الخلف ثم انقلابها خارج الطريق.",
                "عدم الانتباه أدى إلى اصطدام المركبة رقم 1 في المركبة رقم 2 من الخلف ثم انقلابها في الجزيرة الوسطية.",
                "انفجار الإطار الأمامي أدى إلى انحراف المركبة.",
                "انفجار الإطار الأمامي أدى إلى انحراف المركبة خارج الطريق.",
                "انفجار الإطار الأمامي أدى إلى انحراف المركبة وانقلابها في الطريق.",
                "انفجار الإطار الأمامي أدى إلى انحراف المركبة وانقلابها خارج الطريق.",
                "انفجار الإطار الأمامي أدى إلى انحراف المركبة رقم 1 واصطدامها في المركبة رقم 2 من الخلف.",
                "انفجار الإطار الأمامي أدى إلى انحراف المركبة رقم 1 واصطدامها في المركبة رقم 2 من الجنب.",
                "انفجار الإطار الأمامي أدى إلى انحراف المركبة رقم 1 واصطدامها في المركبة رقم 2 من الخلف ثم انقلابها في الطريق.",
                "انفجار الإطار الأمامي أدى إلى انحراف المركبة رقم 1 واصطدامها في المركبة رقم 2 من الخلف ثم انقلابها خارج الطريق.",
                "انفجار الإطار الأمامي أدى إلى انحراف المركبة رقم 1 واصطدامها في المركبة رقم 2 من الخلف ثم انقلابها في الجزيرة الوسطية.",
                "انفجار الإطار الأمامي أدى إلى انحراف المركبة رقم 1 واصطدامها في المركبة رقم 2 من الخلف ثم انقلابها على السياج السلكي.",
                "انفجار الإطار الأمامي أدى إلى انحراف المركبة رقم 1 واصطدامها في المركبة رقم 2 من الخلف ثم انقلابها على السياج السلكي بالجزيرة الوسطية.",
                "انفجار الإطار الأمامي أدى إلى انحراف المركبة رقم 1 واصطدامها في المركبة رقم 2 من الخلف ثم انقلابها على الحاجز المعدني.",
                "انفجار الإطار الأمامي أدى إلى انحراف المركبة رقم 1 واصطدامها في المركبة رقم 2 من الخلف ثم انقلابها على الحاجز الخرساني.",
                "انفجار الإطار الخلفي أدى إلى انحراف المركبة.",
                "انفجار الإطار الخلفي أدى إلى انحراف المركبة خارج الطريق.",
                "انفجار الإطار الخلفي أدى إلى انحراف المركبة وانقلابها في الطريق.",
                "انفجار الإطار الخلفي أدى إلى انحراف المركبة وانقلابها خارج الطريق.",
                "انفجار الإطار الخلفي أدى إلى انحراف المركبة رقم 1 واصطدامها في المركبة رقم 2 من الخلف.",
                "انفجار الإطار الخلفي أدى إلى انحراف المركبة رقم 1 واصطدامها في المركبة رقم 2 من الجنب.",
                "انفجار الإطار الخلفي أدى إلى انحراف المركبة رقم 1 واصطدامها في المركبة رقم 2 من الخلف ثم انقلابها في الطريق.",
                "انفجار الإطار الخلفي أدى إلى انحراف المركبة رقم 1 واصطدامها في المركبة رقم 2 من الخلف ثم انقلابها خارج الطريق.",
                "انفجار الإطار الخلفي أدى إلى انحراف المركبة رقم 1 واصطدامها في المركبة رقم 2 من الخلف ثم انقلابها في الجزيرة الوسطية.",
                "انفجار الإطار الخلفي أدى إلى انحراف المركبة رقم 1 واصطدامها في المركبة رقم 2 من الخلف ثم انقلابها على السياج السلكي.",
                "انفجار الإطار الخلفي أدى إلى انحراف المركبة رقم 1 واصطدامها في المركبة رقم 2 من الخلف ثم انقلابها على السياج السلكي بالجزيرة الوسطية.",
                "انفجار الإطار الخلفي أدى إلى انحراف المركبة رقم 1 واصطدامها في المركبة رقم 2 من الخلف ثم انقلابها على الحاجز المعدني.",
                "انفجار الإطار الخلفي أدى إلى انحراف المركبة رقم 1 واصطدامها في المركبة رقم 2 من الخلف ثم انقلابها على الحاجز الخرساني."
            ],
            damages: ['لايوجد', 'تلفيات بسيطة', 'تلفيات متوسطة', 'تلفيات جسيمة'],
            trafficDelays: [
                "لا يوجد تباطؤ",
                "يوجد تباطؤ بسبب إغلاق مسار واحد ( مسار الشاحنات ).",
                "يوجد تباطؤ بسبب إغلاق مسار واحد ( المسار الأوسط ).",
                "يوجد تباطؤ بسبب إغلاق مسار واحد ( المسار السريع ).",
                "يوجد تباطؤ بسبب إغلاق مسارين ( مسار الشاحنات + المسار الأوسط)",
                "يوجد تباطؤ بسبب إغلاق مسارين ( مسار الشاحنات + المسار السريع )",
                "يوجد تباطؤ بسبب إغلاق مسارين ( مسار الأوسط + المسار السريع )",
                "الطريق مغلق بالكامل"
            ],
            carModels: ['تويوتا كامري', 'تويوتا كورولا', 'هيونداي النترا', 'هيونداي اكسنت', 'شيفروليه كروز', 'فورد تورس', 'نيسان صني', 'مرسيدس بنز', 'بي إم دبليو'],
            contractors: ['مطلق الغويري للمقاولات', 'شركة الجفالي', 'بن لادن للمقاولات']
        };


        class AccidentReportApp {
            constructor() {
                this.accidentType = 'normal';
                this.roads = [];
                this.accidentReasons = [];
                this.damages = [];
                this.trafficDelays = [];
                this.carModels = [];
                this.contractors = [];
                this.currentInjuryType = null;
                this.injuryDetails = {};
                
                this.init();
            }
            
            init() {
                this.loadAllData();
                this.setupEventListeners();
                this.setCurrentDateTime();
                this.updateAllUI();
                
                // إعداد رفع ملف إكسل
                document.getElementById('excel-file').addEventListener('change', (e) => this.handleExcelUpload(e));


                // Set initial values for testing based on your example
                document.getElementById('report-id').value = '508090';
                document.getElementById('road-name-select').value = '15'; // Assuming '15' is the value for "مكة المكرمة / المدينة المنورة"
                this.updateRoadNumberAndType(); // Call this to set the display values
                document.getElementById('kilometer-mark-m').value = '350'; // Changed from 1700 to 350
                document.getElementById('kilometer-mark-km').value = '360';
                document.getElementById('direction').value = 'رئيسي';
                document.getElementById('location-description').value = 'أبيار الماشي';
                document.getElementById('contract-number').value = '404';
                
                // Set initial contractor name, assuming 'مطلق الغويري للمقاولات' is in the default data
                if (this.contractors.includes('مطلق الغويري للمقاولات')) {
                    document.getElementById('contractor-name').value = 'مطلق الغويري للمقاولات';
                }


                // Initial setup for injuries and fatalities
                this.injuryDetails = {
                    injuries: { count: 'لايوجد', details: '' },
                    fatalities: { count: 'لايوجد', details: '' }
                };
                document.getElementById('injuries-count-display').value = 'لايوجد'; 
                document.getElementById('fatalities-count-display').value = 'لايوجد';
                
                document.getElementById('damages-input').value = 'لايوجد';
                document.getElementById('car-count').value = '2';
                // Trigger car input generation on load if a value is present
                this.generateCarInputs(2); 


                document.getElementById('accident-reason-search').value = 'عدم الانتباه أدى إلى انحراف المركبة واصدامها في الحاجز المعدني وانقلابها.';
                document.getElementById('accident-reason-display').value = 'عدم الانتباه أدى إلى انحراف المركبة واصدامها في الحاجز المعدني وانقلابها.';


                document.getElementById('traffic-delay-input').value = 'لا يوجد تباطؤ';
                document.getElementById('weather-condition').value = 'صحو';
                document.getElementById('road-condition').value = 'جيدة';
                document.getElementById('visibility').value = 'واضحة';


                // Initial car details from your example
                document.getElementById('car-type-1').value = 'تويوتا كامري';
                document.getElementById('plate-letters-1').value = 'ا ح م';
                document.getElementById('plate-numbers-1').value = '5008';
                document.getElementById('car-type-2').value = 'تويوتا كورولا';
                document.getElementById('plate-letters-2').value = 'ع ز ز';
                document.getElementById('plate-numbers-2').value = '6006';
            }
            
            loadAllData() {
                this.roads = this.loadData('roads') || DEFAULT_DATA.roads;
                this.accidentReasons = this.loadData('accidentReasons') || DEFAULT_DATA.accidentReasons;
                this.damages = this.loadData('damages') || DEFAULT_DATA.damages;
                this.trafficDelays = this.loadData('trafficDelays') || DEFAULT_DATA.trafficDelays;
                this.carModels = this.loadData('carModels') || DEFAULT_DATA.carModels;
                this.contractors = this.loadData('contractors') || DEFAULT_DATA.contractors;
                
                // Initialize injuryDetails with persistent values or defaults
                this.injuryDetails = this.loadData('injuryDetails') || {
                    injuries: { count: 'لايوجد', details: '' },
                    fatalities: { count: 'لايوجد', details: '' }
                };
            }
            
            saveData(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch (e) {
                    console.error('فشل في حفظ البيانات:', e);
                    alert('حدث خطأ أثناء حفظ البيانات. قد يكون تخزين المتصفح ممتلئًا.');
                    return false;
                }
            }
            
            loadData(key) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (e) {
                    console.error('فشل في تحميل البيانات:', e);
                    return null;
                }
            }
            
            addContractor() {
                const name = document.getElementById('new-contractor').value.trim();
                
                if (!name) {
                    alert('الرجاء إدخال اسم المقاول');
                    return;
                }


                if (this.contractors.includes(name)) {
                    alert('هذا المقاول موجود بالفعل');
                    return;
                }


                this.contractors.push(name);
                
                if (this.saveData('contractors', this.contractors)) {
                    this.updateContractorsUI();
                    document.getElementById('new-contractor').value = '';
                }
            }
            
            removeSelectedContractor() {
                const select = document.getElementById('current-contractors-list');
                const index = select.selectedIndex;
                
                if (index === -1) {
                    alert('الرجاء اختيار مقاول لحذفه');
                    return;
                }


                this.contractors.splice(index, 1);
                
                if (this.saveData('contractors', this.contractors)) {
                    this.updateContractorsUI();
                }
            }
            
            addRoad() {
                const name = document.getElementById('new-road-name').value.trim();
                const number = document.getElementById('new-road-number').value.trim();
                const type = document.getElementById('new-road-type-setting').value;


                if (!name || !number) {
                    alert('الرجاء إدخال اسم ورقم الطريق');
                    return;
                }


                const newRoad = { name, number, type };
                
                if (this.roads.some(r => r.name === name && r.number === number && r.type === type)) {
                    alert('هذا الطريق موجود بالفعل');
                    return;
                }


                this.roads.push(newRoad);
                
                if (this.saveData('roads', this.roads)) {
                    this.updateRoadsUI();
                    document.getElementById('new-road-name').value = '';
                    document.getElementById('new-road-number').value = '';
                }
            }
            
            removeSelectedRoad() {
                const select = document.getElementById('current-roads-list');
                const index = select.selectedIndex;
                
                if (index === -1) {
                    alert('الرجاء اختيار طريق لحذفه');
                    return;
                }


                this.roads.splice(index, 1);
                
                if (this.saveData('roads', this.roads)) {
                    this.updateRoadsUI();
                }
            }
            
            addCarModel() {
                const company = document.getElementById('new-car-company').value.trim();
                const model = document.getElementById('new-car-model').value.trim();
                const fullModel = `${company} ${model}`.trim();


                if (!company || !model) {
                    alert('الرجاء إدخال اسم الشركة والنوع');
                    return;
                }


                if (this.carModels.includes(fullModel)) {
                    alert('هذا النوع موجود بالفعل');
                    return;
                }


                this.carModels.push(fullModel);
                
                if (this.saveData('carModels', this.carModels)) {
                    this.updateCarModelsUI();
                    document.getElementById('new-car-company').value = '';
                    document.getElementById('new-car-model').value = '';
                }
            }
            
            removeSelectedCarModel() {
                const select = document.getElementById('current-car-models-list');
                const index = select.selectedIndex;
                
                if (index === -1) {
                    alert('الرجاء اختيار مركبة لحذفها');
                    return;
                }


                this.carModels.splice(index, 1);
                
                if (this.saveData('carModels', this.carModels)) {
                    this.updateCarModelsUI();
                }
            }
            
            addAccidentReason() {
                const reason = document.getElementById('new-accident-reason').value.trim();


                if (!reason) {
                    alert('الرجاء إدخال سبب الحادث');
                    return;
                }


                if (this.accidentReasons.includes(reason)) {
                    alert('هذا السبب موجود بالفعل');
                    return;
                }


                this.accidentReasons.push(reason);
                
                if (this.saveData('accidentReasons', this.accidentReasons)) {
                    this.updateAccidentReasonsUI();
                    document.getElementById('new-accident-reason').value = '';
                }
            }
            
            removeSelectedAccidentReason() {
                const select = document.getElementById('current-accident-reasons-list');
                const index = select.selectedIndex;
                
                if (index === -1) {
                    alert('الرجاء اختيار سبب لحذفه');
                    return;
                }


                this.accidentReasons.splice(index, 1);
                
                if (this.saveData('accidentReasons', this.accidentReasons)) {
                    this.updateAccidentReasonsUI();
                }
            }
            
            addDamage() {
                const damage = document.getElementById('new-damage').value.trim();


                if (!damage) {
                    alert('الرجاء إدخال وصف التلفيات');
                    return;
                }


                if (this.damages.includes(damage)) {
                    alert('هذا الوصف موجود بالفعل');
                    return;
                }


                this.damages.push(damage);
                
                if (this.saveData('damages', this.damages)) {
                    this.updateDamagesUI();
                    document.getElementById('new-damage').value = '';
                }
            }
            
            removeSelectedDamage() {
                const select = document.getElementById('current-damages-list');
                const index = select.selectedIndex;
                
                if (index === -1) {
                    alert('الرجاء اختيار تلفيات لحذفها');
                    return;
                }


                this.damages.splice(index, 1);
                
                if (this.saveData('damages', this.damages)) {
                    this.updateDamagesUI();
                }
            }
            
            addTrafficDelay() {
                const delay = document.getElementById('new-traffic-delay').value.trim();


                if (!delay) {
                    alert('الرجاء إدخال وصف التباطؤ');
                    return;
                }


                if (this.trafficDelays.includes(delay)) {
                    alert('هذا الوصف موجود بالفعل');
                    return;
                }


                this.trafficDelays.push(delay);
                
                if (this.saveData('trafficDelays', this.trafficDelays)) {
                    this.updateTrafficDelaysUI();
                    document.getElementById('new-traffic-delay').value = '';
                }
            }
            
            removeSelectedTrafficDelay() {
                const select = document.getElementById('current-traffic-delays-list');
                const index = select.selectedIndex;
                
                if (index === -1) {
                    alert('الرجاء اختيار تباطؤ لحذفه');
                    return;
                }


                this.trafficDelays.splice(index, 1);
                
                if (this.saveData('trafficDelays', this.trafficDelays)) {
                    this.updateTrafficDelaysUI();
                }
            }
            
            updateContractorsUI() {
                const select = document.getElementById('contractor-name');
                select.innerHTML = '';
                
                this.contractors.forEach(contractor => {
                    const option = document.createElement('option');
                    option.value = contractor;
                    option.textContent = contractor;
                    select.appendChild(option);
                });
                
                if (this.contractors.length > 0) {
                    // Try to keep the previously selected value, otherwise default to the first
                    const currentContractor = select.value;
                    if (this.contractors.includes(currentContractor)) {
                        select.value = currentContractor;
                    } else {
                        select.value = this.contractors[0];
                    }
                }
                
                // تحديث واجهة الإعدادات
                const settingsList = document.getElementById('current-contractors-list');
                settingsList.innerHTML = '';
                
                this.contractors.forEach((contractor, i) => {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = contractor;
                    settingsList.appendChild(option);
                });
                
                // تحديث الواجهة المنبثقة
                const modalList = document.getElementById('current-contractors-modal');
                modalList.innerHTML = '';
                
                this.contractors.forEach((contractor, i) => {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = contractor;
                    modalList.appendChild(option);
                });
            }
            
            updateRoadsUI() {
                const roadSelect = document.getElementById('road-name-select');
                roadSelect.innerHTML = '';
                
                this.roads.forEach(road => {
                    const option = document.createElement('option');
                    option.value = road.number; // Store road number as value for easier lookup
                    option.textContent = road.name;
                    option.dataset.type = road.type;
                    roadSelect.appendChild(option);
                });


                // Set initial selection for road-name-select and trigger change event
                const defaultRoadNumber = '15'; // Default from your example
                if (this.roads.some(road => road.number === defaultRoadNumber)) {
                    roadSelect.value = defaultRoadNumber;
                } else if (this.roads.length > 0) {
                    roadSelect.value = this.roads[0].number;
                }
                this.updateRoadNumberAndType(); // Update display based on selected road


                const settingsList = document.getElementById('current-roads-list');
                settingsList.innerHTML = '';
                
                this.roads.forEach((road, i) => {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${road.name} (${road.number}, ${road.type})`;
                    settingsList.appendChild(option);
                });
            }


            updateRoadNumberAndType() {
                const roadSelect = document.getElementById('road-name-select');
                const selectedOption = roadSelect.options[roadSelect.selectedIndex];
                if (selectedOption) {
                    document.getElementById('road-number-display').value = selectedOption.value;
                    document.getElementById('road-type').value = selectedOption.dataset.type || 'سريع';
                }
            }
            
            updateCarModelsUI() {
                const datalist = document.getElementById('car-models-options');
                datalist.innerHTML = '';
                
                this.carModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    datalist.appendChild(option);
                });


                const settingsList = document.getElementById('current-car-models-list');
                settingsList.innerHTML = '';
                
                this.carModels.forEach((model, i) => {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = model;
                    settingsList.appendChild(option);
                });
            }
            
            updateAccidentReasonsUI() {
                const datalist = document.getElementById('accident-reason-options');
                datalist.innerHTML = '';
                
                this.accidentReasons.forEach(reason => {
                    const option = document.createElement('option');
                    option.value = reason;
                    datalist.appendChild(option);
                });


                const settingsList = document.getElementById('current-accident-reasons-list');
                settingsList.innerHTML = '';
                
                this.accidentReasons.forEach((reason, i) => {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = reason;
                    settingsList.appendChild(option);
                });
            }
            
            updateDamagesUI() {
                const datalist = document.getElementById('damages-options');
                datalist.innerHTML = '';
                
                this.damages.forEach(damage => {
                    const option = document.createElement('option');
                    option.value = damage;
                    datalist.appendChild(option);
                });


                const settingsList = document.getElementById('current-damages-list');
                settingsList.innerHTML = '';
                
                this.damages.forEach((damage, i) => {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = damage;
                    settingsList.appendChild(option);
                });
            }
            
            updateTrafficDelaysUI() {
                const datalist = document.getElementById('traffic-delay-options');
                datalist.innerHTML = '';
                
                this.trafficDelays.forEach(delay => {
                    const option = document.createElement('option');
                    option.value = delay;
                    datalist.appendChild(option);
                });


                const settingsList = document.getElementById('current-traffic-delays-list');
                settingsList.innerHTML = '';
                
                this.trafficDelays.forEach((delay, i) => {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = delay;
                    settingsList.appendChild(option);
                });
            }
            
            updateAllUI() {
                this.updateContractorsUI();
                this.updateRoadsUI();
                this.updateCarModelsUI();
                this.updateAccidentReasonsUI();
                this.updateDamagesUI();
                this.updateTrafficDelaysUI();
            }
            
            setCurrentDateTime() {
                const now = new Date();
                const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
                
                // التاريخ
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const dayOfMonth = String(now.getDate()).padStart(2, '0');
                const dateStr = `${year}-${month}-${dayOfMonth}`;
                
                document.getElementById('date').value = dateStr;
                document.getElementById('day').value = days[now.getDay()];
                
                // الوقت
                let hours = now.getHours();
                const mins = String(now.getMinutes()).padStart(2, '0');
                const ampm = hours >= 12 ? 'مساءً' : 'صباحًا';
                hours = hours % 12 || 12;
                document.getElementById('hour').value = `${hours}:${mins} ${ampm}`;
            }
            
            updateDayFromDate() {
                const dateInput = document.getElementById('date');
                const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
                
                if (dateInput.value) {
                    const date = new Date(dateInput.value);
                    document.getElementById('day').value = days[date.getDay()];
                }
            }
            
            generateCarInputs(count) {
                const container = document.getElementById('car-details-container');
                container.innerHTML = '';
                
                for (let i = 1; i <= count; i++) {
                    const carDetailHtml = `
                        <div class="car-details">
                            <h4>السيارة رقم ${i}</h4>
                            <div class="form-group">
                                <label for="car-type-${i}"><i class="fa-solid fa-car-side icon"></i> نوعها :</label>
                                <input type="text" id="car-type-${i}" list="car-models-options" placeholder="ادخل نوع المركبة">
                            </div>
                            <div class="form-group car-plate-numbers">
                                <label><i class="fa-solid fa-id-card icon"></i> رقم اللوحة :</label>
                                <span>(</span>
                                <input type="text" id="plate-letters-${i}" placeholder="أحرف">
                                <span>/</span>
                                <input type="text" id="plate-numbers-${i}" pattern="[0-9]*" inputmode="numeric" placeholder="أرقام">
                                <span>)</span>
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', carDetailHtml);
                }


                // If initial values are set, populate them
                if (count >= 1 && document.getElementById('car-type-1')) {
                    document.getElementById('car-type-1').value = 'تويوتا كامري';
                    document.getElementById('plate-letters-1').value = 'ا ح م';
                    document.getElementById('plate-numbers-1').value = '5008';
                }
                if (count >= 2 && document.getElementById('car-type-2')) {
                    document.getElementById('car-type-2').value = 'تويوتا كورولا';
                    document.getElementById('plate-letters-2').value = 'ع ز ز';
                    document.getElementById('plate-numbers-2').value = '6006';
                }
            }
            
            setupEventListeners() {
                document.getElementById('date').addEventListener('change', () => this.updateDayFromDate());
                
                document.getElementById('road-name-select').addEventListener('change', () => this.updateRoadNumberAndType());
                
                document.getElementById('car-count').addEventListener('input', (e) => {
                    const count = parseInt(e.target.value) || 0;
                    this.generateCarInputs(count);
                });
                
                document.getElementById('accident-reason-search').addEventListener('input', (e) => {
                    document.getElementById('accident-reason-display').value = e.target.value;
                });
            }
            
            startReport(type) {
                this.accidentType = type;
                document.getElementById('initial-page').style.display = 'none';
                document.getElementById('report-form-container').style.display = 'block';
                document.getElementById('settings-page').style.display = 'none';
                
                // تحديث عنوان التقرير حسب النوع
                let title = 'بلاغ عاجل بوقوع حادث مروري';
                let color = '#3498db';
                
                if (type === 'fatal') {
                    title = 'بلاغ عاجل بوقوع حادث وفيات';
                    color = '#e74c3c';
                } else if (type === 'injuries') {
                    title = 'بلاغ عاجل بوقوع حادث إصابات';
                    color = '#f39c12';
                }
                
                document.getElementById('report-title').textContent = title;
                document.documentElement.style.setProperty('--h1-after-background', color);
                document.documentElement.style.setProperty('--accent-color', color);
                
                // تحديث عدد الإصابات والوفيات حسب النوع
                if (type === 'fatal') {
                    this.injuryDetails.fatalities.count = 'لايوجد';
                    this.injuryDetails.injuries.count = 'لايوجد';
                } else if (type === 'injuries') {
                    this.injuryDetails.injuries.count = 'لايوجد';
                    this.injuryDetails.fatalities.count = 'لايوجد';
                } else { // normal accident
                    this.injuryDetails.injuries.count = 'لايوجد';
                    this.injuryDetails.fatalities.count = 'لايوجد';
                }
                this.updateInjuryFields();
                
                // توليد حقول السيارات
                const carCount = parseInt(document.getElementById('car-count').value) || 0;
                this.generateCarInputs(carCount);
            }
            
            showSettingsPage() {
                document.getElementById('initial-page').style.display = 'none';
                document.getElementById('report-form-container').style.display = 'none';
                document.getElementById('settings-page').style.display = 'block';
            }
            
            showInitialPage() {
                document.getElementById('initial-page').style.display = 'flex';
                document.getElementById('report-form-container').style.display = 'none';
                document.getElementById('settings-page').style.display = 'none';
            }
            
            showContractorModal() {
                document.getElementById('contractorModal').style.display = 'flex';
            }
            
            closeContractorModal() {
                document.getElementById('contractorModal').style.display = 'none';
            }
            
            addContractorFromModal() {
                const name = document.getElementById('new-contractor-modal').value.trim();
                
                if (!name) {
                    alert('الرجاء إدخال اسم المقاول');
                    return;
                }


                if (this.contractors.includes(name)) {
                    alert('هذا المقاول موجود بالفعل');
                    return;
                }


                this.contractors.push(name);
                
                if (this.saveData('contractors', this.contractors)) {
                    this.updateContractorsUI();
                    document.getElementById('new-contractor-modal').value = '';
                }
            }
            
            removeSelectedContractorFromModal() {
                const select = document.getElementById('current-contractors-modal');
                const index = select.selectedIndex;
                
                if (index === -1) {
                    alert('الرجاء اختيار مقاول لحذفه');
                    return;
                }


                this.contractors.splice(index, 1);
                
                if (this.saveData('contractors', this.contractors)) {
                    this.updateContractorsUI();
                }
            }
            
            selectContractorFromModal() {
                const select = document.getElementById('current-contractors-modal');
                const index = select.selectedIndex;
                
                if (index === -1) {
                    alert('الرجاء اختيار مقاول');
                    return;
                }
                
                document.getElementById('contractor-name').value = this.contractors[index];
                this.closeContractorModal();
            }
            
            showInjuryModal(type) {
                this.currentInjuryType = type;
                const modal = document.getElementById('injuryModal');
                const title = document.getElementById('injury-modal-title');
                const input = document.getElementById('injury-count-input');
                const details = document.getElementById('injury-details');
                
                if (type === 'injuries') {
                    title.innerHTML = '<i class="fa-solid fa-hospital-user"></i> تعديل الإصابات';
                } else {
                    title.innerHTML = '<i class="fa-solid fa-person-falling-burst"></i> تعديل الوفيات';
                }
                
                input.value = this.injuryDetails[type].count;
                details.value = this.injuryDetails[type].details;
                
                modal.style.display = 'flex';
            }
            
            closeInjuryModal() {
                document.getElementById('injuryModal').style.display = 'none';
            }
            
            saveInjuryData() {
                const countInput = document.getElementById('injury-count-input').value.trim();
                const details = document.getElementById('injury-details').value.trim();
                
                // Allow any input without validation
                const countValue = countInput;


                this.injuryDetails[this.currentInjuryType] = {
                    count: countValue,
                    details: details
                };
                
                this.saveData('injuryDetails', this.injuryDetails); // Save injury details
                this.updateInjuryFields();
                this.closeInjuryModal();
            }
            
            updateInjuryFields() {
                document.getElementById('injuries-count-display').value = this.injuryDetails.injuries.count;
                document.getElementById('fatalities-count-display').value = this.injuryDetails.fatalities.count;
            }
            
            showReportModal() {
                const modal = document.getElementById('reportModal');
                const output = document.getElementById('report-output');
                
                // توليد التقرير
                const reportText = this.generateReportText();
                output.value = reportText;
                
                modal.style.display = 'flex';
            }
            
            closeReportModal() {
                document.getElementById('reportModal').style.display = 'none';
            }
            
            copyTextFromModal() {
                const output = document.getElementById('report-output');
                output.select();
                document.execCommand('copy');
                
                const successMsg = document.getElementById('successMessage');
                successMsg.style.display = 'block';
                setTimeout(() => {
                    successMsg.style.display = 'none';
                }, 3000);
            }
            
            handleExcelUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                const fileName = document.getElementById('file-name');
                fileName.textContent = `تم اختيار: ${file.name}`;
                
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        
                        if (jsonData.length === 0) {
                            alert('ملف الإكسل لا يحتوي على بيانات');
                            return;
                        }
                        
                        // معالجة البيانات واستخراج الطرق والعقود
                        const newRoads = [];
                        const contractNumbers = new Set();
                        
                        jsonData.forEach(row => {
                            const contractNumber = String(row['رقم العقد'] || row['Contract'] || '');
                            const roadNumber = String(row['رقم الطريق'] || row['Number'] || '');
                            const roadName = row['اسم الطريق'] || row['Name'] || '';
                            const roadType = row['نوع الطريق'] || row['Type'] || 'سريع';
                            
                            if (roadName && roadNumber) {
                                // Prevent duplicates based on name, number, and type
                                if (!this.roads.some(r => r.name === roadName && r.number === roadNumber && r.type === roadType)) {
                                    newRoads.push({
                                        name: roadName,
                                        type: roadType,
                                        number: roadNumber
                                    });
                                }
                            }
                            
                            if (contractNumber) {
                                contractNumbers.add(contractNumber);
                            }
                        });
                        
                        // تحديث قائمة الطرق
                        if (newRoads.length > 0) {
                            this.roads = [...this.roads, ...newRoads];
                            this.saveData('roads', this.roads);
                            this.updateRoadsUI();
                        }
                        
                        // تحديث حقل رقم العقد إذا كان هناك أرقام عقود
                        if (contractNumbers.size > 0) {
                            const contractField = document.getElementById('contract-number');
                            if (!contractField.value || contractField.value === '404') { // Only update if empty or default
                                contractField.value = Array.from(contractNumbers).join(', ');
                            }
                        }
                        
                        alert(`تم تحميل ${newRoads.length} طريق من ملف الإكسل`);
                        
                    } catch (error) {
                        console.error('حدث خطأ أثناء معالجة ملف الإكسل:', error);
                        alert('حدث خطأ أثناء معالجة ملف الإكسل. يرجى التأكد من تنسيق الملف.');
                    }
                };
                
                reader.readAsArrayBuffer(file);
            }
            
            generateReportText() {
                // جمع بيانات التقرير من النموذج
                const reportId = document.getElementById('report-id').value;
                const roadName = document.getElementById('road-name-select').options[document.getElementById('road-name-select').selectedIndex]?.textContent || '';
                const roadNumber = document.getElementById('road-number-display').value;
                const roadType = document.getElementById('road-type').value;
                const km = document.getElementById('kilometer-mark-km').value || '0';
                const m = document.getElementById('kilometer-mark-m').value || '0';
                const direction = document.getElementById('direction').value;
                const locationDesc = document.getElementById('location-description').value;
                const contractNumber = document.getElementById('contract-number').value;
                const contractorName = document.getElementById('contractor-name').value;
                
                const injuriesCount = this.injuryDetails.injuries.count;
                const injuriesDetails = this.injuryDetails.injuries.details;
                const fatalitiesCount = this.injuryDetails.fatalities.count;
                const fatalitiesDetails = this.injuryDetails.fatalities.details;
                
                const damages = document.getElementById('damages-input').value;
                const carCount = parseInt(document.getElementById('car-count').value) || 0;
                const accidentReason = document.getElementById('accident-reason-display').value;
                const hour = document.getElementById('hour').value;
                const dateInput = document.getElementById('date').value;
                const day = document.getElementById('day').value;
                const trafficDelay = document.getElementById('traffic-delay-input').value;
                const weather = document.getElementById('weather-condition').value;
                const roadCondition = document.getElementById('road-condition').value;
                const visibility = document.getElementById('visibility').value;


                // Format the date to day / month / year
                let formattedDate = '';
                if (dateInput) {
                    const dateParts = dateInput.split('-'); // YYYY-MM-DD
                    if (dateParts.length === 3) {
                        formattedDate = `${dateParts[2]} / ${dateParts[1]} / ${dateParts[0]}`; // DD / MM / YYYY
                    }
                }
                
                // جمع بيانات السيارات
                const cars = [];
                for (let i = 1; i <= carCount; i++) {
                    const type = document.getElementById(`car-type-${i}`).value;
                    const letters = document.getElementById(`plate-letters-${i}`).value;
                    const numbers = document.getElementById(`plate-numbers-${i}`).value;
                    
                    cars.push({
                        type,
                        plate: letters && numbers ? `( ${letters} / ${numbers} )` : ''
                    });
                }
                
                // جمع الإجراءات
                const actions = [];
                if (document.getElementById('action1').checked) {
                    actions.push('• 1️⃣ تأمين موقع الحادث .');
                }
                
                const cleaningStatus = document.querySelector('input[name="cleaning-status"]:checked')?.value;
                if (cleaningStatus) {
                    actions.push(`• 2️⃣ ${cleaningStatus}`);
                }
                
                if (document.getElementById('action3').checked) {
                    actions.push('• 3️⃣ وضع وسائل السلامة .');
                }
                
                // بناء نص التقرير بالصيغة المطلوبة
                let report = `🟡 بلاغ عاجل بوقوع حادث مروري 🟡\n\n`;
                report += `🔳 رقم البلاغ في رقابة +: (${reportId})\n\n`;
                
                report += `📍 معلومات الموقع\n`;
                report += `🛣 اسم الطريق : ${roadName}\n`;
                report += `🛣 نوع الطريق : ${roadType}\n`;
                report += `🛣 رقم الطريق : ${roadNumber}\n`;
                report += `🛣 العلامة الكيلومترية: (${km} + ${m})\n`;
                report += `🛣 الاتجاه : ${direction}\n`;
                report += `🛣 وصف الموقع : ${locationDesc}\n`;
                report += `🛣 رقم العقد : ${contractNumber}\n`;
                report += `🛣 اسم المقاول : ${contractorName}\n\n`;
                
                report += `🛑 نتيجة الحادث\n`;
                report += `⛑ عدد الإصابات : ${injuriesCount}\n`;
                // Add injury details if available and not 'لايوجد'
                if (injuriesCount !== 'لايوجد' && injuriesDetails) {
                    report += `  (تفاصيل: ${injuriesDetails})\n`;
                }
                report += `⛑ عدد الوفيات : ${fatalitiesCount}\n`;
                // Add fatality details if available and not 'لايوجد'
                if (fatalitiesCount !== 'لايوجد' && fatalitiesDetails) {
                    report += `  (تفاصيل: ${fatalitiesDetails})\n`;
                }
                report += `⛑ التلفيات: ${damages}\n\n`;
                
                report += `🚙 عدد السيارات : ${carCount}\n`;
                cars.forEach((car, i) => {
                    report += `${i + 1}: 🚘 نوعها : ${car.type}\n`;
                    report += `  رقم اللوحة : ${car.plate}\n`;
                });
                if (cars.length === 0) {
                     report += `  لا يوجد سيارات متورطة\n`;
                }
                report += `\n`;


                report += `📃 سبب الحادث : ${accidentReason}\n\n`;
                
                report += `■ الساعة: ${hour}\n`;
                report += `■ التاريخ: ${formattedDate}\n`;
                report += `■ اليوم : ${day}\n\n`;
                
                report += `🗒 معلومات عامة\n`;
                report += `🏁 زمن تباطؤ حركة المرور: ${trafficDelay}\n`;
                report += `🏞 الحالة الجوية : ${weather}\n`;
                report += `🛣 حالة الطريق : ${roadCondition}\n`;
                report += `👓 وضوح الرؤية : ${visibility}\n\n`;
                
                report += `🚨 الإجراء الذي تم من قبل المقاول\n`;
                actions.forEach(action => {
                    report += `${action}\n`;
                });
                
                report += `\n🚧 المرور والسلامة بالمشروع 🚧`;
                
                return report;
            }
        }


        // تهيئة التطبيق عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new AccidentReportApp();
            app.updateRoadNumberAndType(); // Ensure road number and type are set on load
        });
    </script>
</body>
</html>
